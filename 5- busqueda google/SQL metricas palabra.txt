-- HACER TRIMMMM!!!!!

IF OBJECT_ID('tempdb..#tmp_paginas_por_dia') IS NOT NULL DROP TABLE #tmp_paginas_por_dia;
select
fechaini,
count(distinct pagina) paginas_por_dia,
count(distinct LTRIM(RTRIM(palabra))) palabras_por_dia
into #tmp_paginas_por_dia
from
tmp_webpage
group by 
fechaini

/*
select 
count(distinct palabra)
from
tmp_webpage
where 1=1
and fechaini = '20180320'
*/

select *
from
#tmp_paginas_por_dia

IF OBJECT_ID('tempdb..#tmp_metricas_palabras') IS NOT NULL DROP TABLE #tmp_metricas_palabras;
select 
LTRIM(RTRIM(wp.palabra)) palabra,
wp.fechaini,
count(*) cantidad_dia,
count(distinct wp.pagina) paginas_distintas,
max(pd.paginas_por_dia) paginas_por_dia,
max(pd.palabras_por_dia) palabras_por_dia,
100.0*count(*)/max(pd.palabras_por_dia) share_palabras_dia,
100.0*count(distinct wp.pagina)/max(pd.paginas_por_dia) share_paginas_dia
into #tmp_metricas_palabras
from
tmp_webpage wp
inner join #tmp_paginas_por_dia pd on wp.fechaini = pd.fechaini
group by 
LTRIM(RTRIM(wp.palabra)),
wp.fechaini
;



select
*
from
#tmp_metricas_palabras
WHERE 1=1
and share_palabras_dia <3
and share_paginas_dia > 30
and paginas_distintas > 3
order by 
paginas_distintas
desc





select
*
from
#tmp_metricas_palabras
WHERE 1=1
order by 
paginas_distintas
desc

